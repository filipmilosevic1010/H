#include "operacije.c"

FILE *otvoriDatoteku(char *filename)
{
    FILE *fajl = fopen(filename, "rb+");

    if(fajl == NULL) {
        printf("Ne postoji datoteka!");
    }
    else{
        printf("otvorena je datoteka %s", filename);
    }

    return fajl;
}

void kreirajDatoteku(char *filename)
{
    FILE *fajl = fopen(filename, "wb");

    if(fajl == NULL) {
        printf("NEMORE");

    }
    else{
        BLOK blok;
        blok.slogovi[0].sifraPozajmice = OZNAKA_KRAJA_DATOTEKE;
        fwriite(&blok, sizeof(BLOK), 1, fajl);
        printf("Datoteka %s je uspjesno kreirana", filename);
        fclose(fajl);
    }
}

void ispisiSlog(SLOG *slog)
{ 
    printf("%10d %-30s %10d %-30s %10d %-10s %10d",
        slog -> sifraPozajmice,
        sloh -> imePrezimeClana,
        slog -> brojClanskeKarte,
        slog ->nazivKnjige,
        slog -> autorKnjige,
        slog ->sifraKnjige,
        slog ->datumPozajmice,
        slog -> trajanjePozajmice);
    
}

void ispisiSveSlogove(FILE *fajl)
{
    if(fajl == NULL) {
        printf("D nije otvorena");
        return;
    }

    fseek(fajl, 0, SEEK_SET);
    BLOK blok;
    int rbBloka = 0;
    printf("\nBL SL SIFRA POZ IME I PREZIME CLANA Br. clanske karte Naziv knjige autor knjiga sifra knj datum pozajm trajanje");


    while(fread(&blok, sizeof(BLOK), 1, fajl))
    {
        for(int i = 0; i < FBLOKIRANJA; i++) {
            if(blok.slogovi[i].sifraPozajmice == OZNAKA_KRAJA_DATOTEKE) {
                printf("B%d SL%d *\n", rbBLOKA, i);
                return;
            }
            else if(blok.slogovi[i].deleted == 0)
            {
                printf("B%d SL%d \n", rbBloka, i);
                ispisiSlog(&blok.slogovi[i]);
                printf("\n");
            }
        }
        rbBloka++;

    }
}

//Z1
void obrisiPozajmiceSaClBrojem0(FILE *fajl)
{
    if(fajl == NULL) {
        printf("Ne more bez stapa");
        return;
    }

    fseek(fajl, 0, SEEK_SET);
    BLOK blok;
    int brojObrisanih = 0;

    while(fread(&blok, sizeof(BLOK), 1, fajl)){
        int blokIzmenjen = 0;

        for(int i = 0; i < FBLOKIRANJA; i++){
            if(blok.slogovi[i].sifraPozajmice == OZNAKA_KRAJA_DATOTEKE){
                break;
            }

            if(blok.slogovi[i].brojClanskeKarte == 0 && blok.slogovi[i].deleted == 0)
            {
                blok.slogovi[i].deleted = 1;
                blokIzmenjen = 1;
                brojObrisanih++;
                printf("Lo obrisan slog sa sifrom pozajmice %d\n", blok.slogovi[i].sifraPozajmice);

            }
        }

        if(blokIzmenjen == 1){
            fseek(fajl, -(long)sizeof(BLOK),SEEK_CUR);
            fwrite(&blok, sizeof(BLOK), 1, fajl);
            fseek(fajl, 0, SEEK_CUR);

        }
    }
    printf("\nUkupno logicki obrisano %s\n", brojObrisanih);
}

//Z2 
void kreirajIzvjestajDugihPozajmica(FILE *filePozajmica, char *fajlIzvjestajNaziv)
{
    if(filePozajmica == NULL){}
}

//Z3
void ispisiSveSlogoveIzvjestaja(FILE *fajl)
{
    if(fajl ==NULL){
        printf("ne");
        return;
    }

    fseek(fajl, 0, SEEK_SET);
    BLOK_IZVJESTAJ blok;
    int rbBLOKA = 0;

    printf("BL SL BrClKart ImePrz clana\n");
    printf("==============================\n");

    while(fead(&blok, sizeof(BLOK_IZVJESTAJ), 1, fajl)){
        for(int i = 0; i < FBLOKIRANJA; i++){
            if(blok.slogovi[i].brojClanskeKarte == OZNAKA_KRAJA_DATOTEKE){
                printf("B%d SL%d *\n", rbBLOKA, i);
                return;
            }
            else{
                printf("B%d SL%d %10d %-30s\n", rbBloka, i, 
                blok.slogovi[i].brojClanskeKarte,
                blok.slogovi[i].imePrezimeClana
                );
                printf("\n");
            }
        }
        rbBloka++;
    }
}

//Z4

void prikaziBrojpozajmljivanjaKnjige(FILE *fajl, char *nazivKnjige)
{
    if(fahjl == NULL){
        printf("ne");
        return;
    }
    fseek(fajl, 0, SEEK_SET);
    BLOK blok;
    int brojPozajmljivanja = 0;

    while(fread(&blok, sizeof(BLOK), 1, fajl)) {
        for(int i = 0; i < FBLOKIRANJA; i++){
            if(blok.slogovi[i].sifraPozajmice == OZNAKA_KRAJA_DATOTEKE) {
                goto kraj_pretage;
            }

            if(blok.slogovi[i].deleted == 1){
                continue;
            }

            if(strcmp(blok.slogovi[i].nazivKnjige, nazivKnjige) == 0) {
                brojPozajmljivanja++;
            }
        }
    }
kraj_pretrage:
    printf("\nKnjiga %s je pozajmljena %d puta. \n", nazivknige, brojPozajmljivanja);
}
